<!-- изменил Пулин дата 12.08.2025 задача  -->
<!-- изменил Пулин дата 24.07.2025 задача  -->
<!--Начальная дата разработки 14.07.2025 г.-->
<!--Разработка: Пулин -->
<!--Контекст печати:  -->
<!--Задача:  -->

<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Карта ухода и лечения пациента с пролежнями</title>
<!-- @formatter:off -->
{: setPageSize('A4')}
{: setOrientation('P')}
{: setTopMargin(5)}
{: setBottomMargin(5)}
{: setRightMargin(17)}
{: setLeftMargin(17)}

{: from library.Utils import forceString }
{: from library.Utils import forceInt }
{: from PyQt4 import QtGui }
{: db = QtGui.qApp.db }
{: from datetime import datetime, timedelta}
{: import math}

{: month = [u'a', u'января', u'февраля', u'марта', u'апрель', u'мая', u'июня', u'июля', u'августа', u'сентября', u'октября', u'ноября', u'декабря']}

{:
write('''
<style>
.h1 {
    text-align: center;
    margin-bottom: 20px;
    font-size: 12pt;
    font-weight: 900;
}
.main {
    font-family: 'Times New Roman';
    font-size: 10pt;
}


.tbl-card td,
.tbl-card th {
    font-size: 10pt;
    white-space: nowrap;
    border: 1px solid #999;
}

.tbl-card td:not(:first-child),
.tbl-card th:not(:first-child) {
    width: 15px;
    max-width: 15px;
    min-width: 15px;
}

.tbl-card td:first-child,
.tbl-card th:first-child {
    width: 1%;
    max-width: 1%;
    min-width: 1%;
    white-space: nowrap;
}
.td-title {
    font-weight: 900;
}
.td-subtitle {
    padding-left: 10px;
    font-weight: 400;
}
.underline {
    text-decoration: underline;
}
</style>
''')}

{:
start_period = datetime.strptime(today, '%Y-%m-%d %H')
start_period = start_period.replace(hour=8)
end_period = start_period + timedelta(days=1, hours=-1)
}


{:
act_id_ref_list = db.getRecordList(stmt=u"""
  select a.id as act_id
  from Action a
  where a.event_id = {event_id}
    and a.actionType_id = 26640
    and a.begDate between '{start_period}' and '{end_period}'
""".format(event_id=event.id, start_period=start_period, end_period=end_period))
}

{:
act_id_list = []
if act_id_ref_list:
  for act_id_ref in act_id_ref_list:
    act_id_list.append(forceInt(act_id_ref.value(u'act_id')))
}

{: safety_prop_keys = [u'Согласие пациентана', u'Оценка по шкале Нортон', u'Дата обучения пациента самоуходу', u'Дата консультации лечащеего врача с диает-сестрой', u'Локализация полежня 1:', u'Стадия пролежня 1:', u'Локализация полежня 2:', u'Стадия пролежня 2:', u'Локализация полежня 3:', u'Стадия пролежня 3:', u'Состояние коженных покровов:', u'Изменение положения/состояния в постели', u'Диета: введено в зонд, мл.', u'Диета: кол-во съеденной пищи, %', u'Диета:  кол-во выпитой жидкости, мл.']}
{: day_acts = dict()}
{for: act in event.actions}
  {if: act.id in act_id_list}
    <!-- note когда починят пропы с типом reference, убрать начиная с этой строки -->
    {: act_dict = dict()}
    {for: prop_key in safety_prop_keys}
      {: value = act[prop_key]}
      {: act_dict.data.setdefault(prop_key, value)}
    {end:}
    <!-- note когда починят пропы с типом reference, убрать заканчивая с этой строкой -->
    {: hour_key = forceInt(act.begDate.time.hour())}
    <!-- note когда починят пропы с типом reference, вместо act_dict присваивать act -->
    {: day_acts.data.setdefault(hour_key, act_dict)}
  {end:}
{end:}

{:
def get_prop_value(obj, hour_key, prop_key):
  value = ''
  act = obj.data.get(hour_key, None)
  if act:
    value = act.data.get(prop_key, '')
  return value
}  



<!-- @formatter:on -->
</head>
<body>


<div class="main">
  <div class="h1">
    Карта ухода и лечения пациента с пролежнями
    Ф.И.О. пациента {client.fullName}
  </div>

  <section>
    <table width="100%" cellpadding="0" cellspacing="0">
      <tr>
        <td>
          1. Согласие пациента на предложенный план ухода
          {for: name in [u"Имеется", u"Неимеется"]}
            <span class="{u'underline' if name == get_prop_value(day_acts, 8, u'Согласие пациентана') else ''}">{name}</span>
          {end:}
        </td>
        <td>
          дата
        </td>
        <td>
            <b>{start_period.strftime('%d.%m.%Y')}</b>
        </td>
      </tr>
      <tr>
        <td>
              2. Оценка риска развития и стадии пролежней по шкале Нортон (сумма баллов) <b>{get_prop_value(day_acts, 8, u'Оценка по шкале Нортон')}</b>
        </td>
        <td>ИБ №</td>
        <td>
          <b>{event.id}</b>
        </td>
      </tr>
    </table>


    <div>
      3. Согласовано с врачом, ФИО врача полностью
    <!--  TODO -->
    </div>
    <div>
      4. Дата обучения пациента самоуходу <b>{get_prop_value(day_acts, 8, u'Дата обучения пациента самоуходу')}</b>
    </div>
    <div>
      5. Дата консультации лечащего врача с диет-сестрой (корректировка питания) <b>{get_prop_value(day_acts, 8, u'Дата консультации лечащеего врача с диает-сестрой')}</b>
    </div>
  </section>

  <table width="100%" cellpadding="3" cellspacing="0" class="tbl-card">
    {: hour_list = [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 0, 1, 2, 3, 4, 5, 6, 7]}

    <tr>
      <td class="td-title">Время суток</td>
      {for: hour in hour_list}
        <th>{hour}</th>
      {end:}
    </tr>

    <tr>
      <th colspan="{len(hour_list) + 1}">Оценка развития и стадии пролежней</th>
    </tr>

    <tr>
      <td colspan="{len(hour_list) + 1}" class="td-title">Риск развития пролежней:</td>
    </tr>
    {: sub_title_name_list = [u'низкий', u'средний', u'высокий']}
    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: _ in hour_list}
          <td>&nbsp;</td>
        {end:}
      </tr>
    {end:}

    {: CELL_AMOUNT = 12}
    {: COLSPAN = 2}
    {: colspan_set = set()}
    {: prop_name_list = [u'Локализация полежня 1:', u'Локализация полежня 2:', u'Локализация полежня 3:']}
    <tr>
      <td class="td-title">Локализация пролежня:</td>
      {: current_list = []}
      {for: name in prop_name_list}
        {: value = get_prop_value(day_acts, 8, name)}
        {if: value != ''}
          {: current_list.append(1)}
           <td colspan="{COLSPAN}">{value}</td>
        {end:}
      {end:}
      {for: _ in range(CELL_AMOUNT - len(current_list) * COLSPAN)}
        <td>&nbsp;</td>
      {end:}
      {: colspan_set.add(len(current_list))}

      {: current_list = []}
      {for: name in prop_name_list}
        {: value = get_prop_value(day_acts, 20, name)}
        {if: value != ''}
          {: current_list.append(1)}
           <td colspan="{COLSPAN}">{value}</td>
        {end:}
      {end:}
      {for: _ in range(CELL_AMOUNT - len(current_list) * COLSPAN)}
        <td>&nbsp;</td>
      {end:}
      {: colspan_set.add(len(current_list))}
    </tr>

    {: prop_name_list = [u'Стадия пролежня 1:', u'Стадия пролежня 2:', u'Стадия пролежня 3:']}
    <tr>
      <td class="td-title">Стадия пролежня:</td>
      {: current_list = []}
      {for: name in prop_name_list}
        {: value = get_prop_value(day_acts, 8, name)}
        {if: value != ''}
          {: current_list.append(1)}
           <td colspan="{COLSPAN}">{value}</td>
        {end:}
      {end:}
      {for: _ in range(CELL_AMOUNT - len(current_list) * COLSPAN)}
        <td>&nbsp;</td>
      {end:}
      {: colspan_set.add(len(current_list))}

      {: current_list = []}
      {for: name in prop_name_list}
        {: value = get_prop_value(day_acts, 20, name)}
        {if: value != ''}
          {: current_list.append(1)}
           <td colspan="{COLSPAN}">{value}</td>
        {end:}
      {end:}
      {for: _ in range(CELL_AMOUNT - len(current_list) * COLSPAN)}
        <td>&nbsp;</td>
      {end:}
      {: colspan_set.add(len(current_list))}
    </tr>

    {: max_colspan = max(colspan_set) if len(colspan_set) > 0 else 1}
    <tr>
      <td class="td-title">Состояние кожных покровов: <b>{range(CELL_AMOUNT - max_colspan * COLSPAN)}</b></td>
       <td colspan="{max_colspan * COLSPAN}">{get_prop_value(day_acts, 8, u'Состояние коженных покровов:')}</td>
      {if: max_colspan == 0}
        {: current_cell_amount = CELL_AMOUNT - 1}
      {else:}
        {: current_cell_amount = CELL_AMOUNT - max_colspan * COLSPAN}
      {end:}

      {for: _ in range(current_cell_amount)}
        <td>&nbsp;</td>
      {end:}

       <td colspan="{max_colspan * COLSPAN}">{get_prop_value(day_acts, 20, u'Состояние коженных покровов:')}</td>
      {for: _ in range(current_cell_amount)}
        <td>&nbsp;</td>
      {end:}
    </tr>

    <tr>
      <td colspan="{len(hour_list) + 1}" class="td-title">Уход за кожей:</td>
    </tr>

    {: sub_title_name_list = [u'Присыпки (безтальковые)', u'Увлажняющий крем', u'Разогревающий крем']}
    {: current_prop_name = u'Противопролежные мероприятия:'}
    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: hour in hour_list}
          <td>

            {if: get_prop_value(day_acts, hour, current_prop_name) == name}
                +
            {else:}
              &nbsp;
            {end:}
          </td>
        {end:}
      </tr>
    {end:}

    <tr>
      <th colspan="{len(hour_list) + 1}">Регистрация противопролежневых мероприятий</th>
    </tr>


    <tr>
      <td colspan="{len(hour_list) + 1}" class="td-title">Изменение положения/состояния в постели</td>
    </tr>

    {: sub_title_name_list = [u"Фаулера", u"Лежа на лев. боку", u"Лежа на пр. боку", u"Симса", u"Лежа на спине", u"Сидя свесив ноги", u"ЭКМО", u"Лежа на спине вынужденно"]}
    {: current_prop_name = u'Изменение положения/состояния в постели'}
    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: hour in hour_list}
          <td>
            {if: get_prop_value(day_acts, hour, current_prop_name) == name}
                +
            {else:}
              &nbsp;
            {end:}
          </td>
        {end:}
      </tr>
    {end:}

    <tr>
      <td colspan="{len(hour_list) + 1}" class="td-title">Противолежневые средства:</td>
    </tr>

    {: sub_title_name_list = [u'Матрас противопролежный', u'Абсордирующее белье']}
    {: current_prop_name = u'Противопролежные мероприятия:'}
    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: hour in hour_list}
          <td>
            {if: name in get_prop_value(day_acts, hour, current_prop_name)}
                +
            {else:}
              &nbsp;
            {end:}
          </td>
        {end:}
      </tr>
    {end:}



    {: sub_title_name_list = [u'Затылок', u'Плечи', u'Локти', u'Крестец', u'Пятки', u'Область тазобедренного сустава', u'Колено', u'Лодыжки', u'Лопатки', u'Подушечьки пальцев']}
    {: current_prop_name = u'Мероприятия для:'}
    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: hour in hour_list}
          <td>
            {if: name in get_prop_value(day_acts, hour, current_prop_name)}
                +
            {else:}
              &nbsp;
            {end:}
          </td>
        {end:}
      </tr>
    {end:}


    <tr>
      <td>
        Проверка состояния постели <br>
        при перемене положения
      </td>
      {for: _ in hour_list}
        <td>&nbsp;</td>
      {end:}
    </tr>



    <tr>
      <td colspan="{len(hour_list) + 1}" class="td-title">Гигиенические процедуры</td>
    </tr>

    {: sub_title_name_list = [u'Обтирание (проф.губка)', u'Мытье в постели', u'Уход за промежностью и наружными половыми органами', u'Мытье головы (шапочка)']}
    {: current_prop_name = u'Противопролежные мероприятия:' }
    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: hour in hour_list}
          <td>
            {if: name in get_prop_value(day_acts, hour, current_prop_name)}
                +
            {else:}
              &nbsp;
            {end:}
          </td>
        {end:}
      </tr>
    {end:}

    <tr>
      <td align="center" colspan="{len(hour_list) + 1}" class="td-title">Профилактические мероприятия застойных явлений в легких</td>
    </tr>

    {: sub_title_name_list = [u'Дыхательная гимнастика', u'Перкуторный массаж']}

    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: hour in hour_list}
          <td>
            {if: name in get_prop_value(day_acts, hour, current_prop_name)}
                +
            {else:}
              &nbsp;
            {end:}
          </td>
        {end:}
      </tr>
    {end:}

    <tr>
      <td colspan="{len(hour_list) + 1}" class="td-title">Диетические назначения</td>
    </tr>
    {: sub_title_name_list = [u'Диета: введено в зонд, мл.', u'Диета: кол-во съеденной пищи, %', u'Диета:  кол-во выпитой жидкости, мл.']}
    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name.split(u':')[1].strip()}</td>
        {for: hour in hour_list}
          <td>
            {get_prop_value(day_acts, hour, name)}
          </td>
        {end:}
      </tr>
    {end:}


    <tr>
      <td colspan="{len(hour_list) + 1}" class="td-title">Лечение пролежней</td>
    </tr>
    {: sub_title_name_list = [u'Консльтация врача/хирурга', u'мази, гели', u'антисептики', u'гидрогелевые повязки', u'противоспалительные средства', u'перевязки', u'посев жикости', u'удаление мертвых тканей', u'антибиоткики', u'б/посев', u'некрэктомия']}
    {: current_prop_name = u'Противопролежные мероприятия:' }


    {for: name in sub_title_name_list}
      <tr>
        <td class="td-subtitle">{name}</td>
        {for: hour in hour_list}
          <td>
            {if: name in get_prop_value(day_acts, hour, current_prop_name)}
                +
            {else:}
              &nbsp;
            {end:}
          </td>
        {end:}
      </tr>
    {end:}

  </table>

  <table width="100%" cellpadding="0" cellspacing="0">
    <tr>
      <td>Врач</td>
      <td>{'_' * 20}</td>
      <td>Деж. врач</td>
      <td>{'_' * 20}</td>
    </tr>
    <tr>
      <td>Медсестра</td>
      <td>{'_' * 20}</td>
      <td>Деж. медсестра</td>
      <td>{'_' * 20}</td>
    </tr>
  </table>
</div>
</body>
</html>