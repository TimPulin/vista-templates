<!-- Изменил: Кириенко Дата: 29.01.2025 задача DEV_TEMP-4932 При печати некорректно отображаются наименование исследований -->
<!-- Изменил: Салин Роман Дата: 20.01.2025 -->
<!--Кто и когда делал - хз -->
<!-- Изменил: Ноговицын Ярослав Эдуардович. Дата: 31.07.2023. KPTD-309 Шаблон для направлений на анализы. -->
<!-- Изменил: Ильин Александр Владиирович. Дата: 17.10.2023. KPTD-478 Проблема при назначении лабораторных исследование КДЛ -->
<!--изменил Пулин дата 02.02.2024 задача KPTD-598 В направлениях на анализы необходимо рядом с датой рождения в скобочках писать возраст пациента-->
<html>
<head>
{setPageSize('A5')}
{setOrientation('P')}
{setMargins(0)}
{: from PyQt4 import QtGui }
{: from library.Utils import forceString }
{: db = QtGui.qApp.db }

{: names = []}
{:rentgen = [u'Рентген']}
{:mamgr = [u'Маммография']}
{:fvd = [u'функция внешнего дыхания']}
{:fvdp = [u'функция внешнего дыхания с пробой']}
{:ekg = [u'ЭКГ']}
{:xm = [u'холтеровское мониторирование']}
{:xmad = [u'холтеровское мониторирование с АД']}
{:yzib = [u'УЗИ щитовидной железы']}
{:yzia = [u'УЗДГ БЦА']}
{:yzi = [u'УЗИ']}
{:yzigen = [u'УЗИ ЖК (Гинекологическое)']}
{:yzibrem = [u'УЗИ ЖК (Скрининг беременных)']}
{:yzimg = [u'УЗИ молочных желез']}
{:yzdg = [u'УЗДГ сосудов нижних конечностей']}
{:yzp = [u'УЗДГ БЦА и ТК']}
{:yzdva = [u'УЗИ ЖК(скрининг двойня)']}
{:exo = [u'ЭХО']}

</head>
<body STYLE="font-size: 9pt;">

{: tickets = []}
{: referrals = []}
{for: act in event.actions}
    {if: act.class_ == 1 and act.status != 2}
        {for: prop in act}
            {if: prop.name.lower() == u'номерок' and prop.value}
                {: referrals.insert(0, act)}
                {: tickets.insert(0, prop.value + ', ' + act.name + ', ' + str(prop.value.idx))}
            {end:}
        {end:}
    {end:}
{end:}

{:dial = dialogs.dialMultiList(u"Выберите шаблон", map(forceString, tickets), 0)}
{: chosenIndexes = dial.getVar()}

{: unique_tickets = dict()}
{for: id in chosenIndexes}
    {if: not isinstance(id, int)} <!--Фикс для веб-версии -->
        {: id = next((i for i, ticket in enumerate(tickets) if forceString(ticket) == id), -1)}
    {end:}
    {if: id != -1}
        {: ticket = tickets[id]}
        {: act = referrals[id]}
        {: tissueCodeRef = db.getRecordEx(stmt=u"""select ttj.id
                from Action a
                inner join TakenTissueJournal ttj on a.takenTissueJournal_id = ttj.id
                where a.id = {};""".format(act.id)) }
        {: tissue_code = forceString(tissueCodeRef.value('id')) if tissueCodeRef else ''}
<h2>{act.id}</h2>
<div>ticket {ticket}</div>
        {: ticket_identity = u','.join(forceString(ticket).split(',')[:-2] + [tissue_code, ])}
        {: analysis = [ticket.split(', ')[-1], forceString(ticket), forceString(act.title) or forceString(act.name), tissue_code, forceString(act.group.name)]}
        {: unique_tickets.data.setdefault(ticket_identity, []).append(analysis)}
    {end:}
{end:}




{for: analysis_list in filter(len, unique_tickets.data.values())}
    {: referral_idx, referral, act_title, tissue_code, act_group_name = analysis_list[0]}
    {: referral_name = referral.split(',')[0]}
    {: comment = None}
    {if: act_group_name == u'Лучевая диагностика 17' and referral_name in rentgen}
        {: comment = """Указать область исследования___________________________________<br/>Ds: ____________________________________________<br/>
        С собой необходимо иметь амбулаторную карту, пеленку, сменную обувь"""}
    {elif: act_group_name == u'Лучевая диагностика 17' and referral_name in mamgr}
        {: comment = "С собой необходимо иметь сменную обувь и паспорт"}
    {elif: act_group_name.startswith(u'Функциональная диаг') and referral_name in fvd}
        {: comment = "С собой необходимо иметь амбулаторную карту, ФЛГ"}
    {elif: act_group_name.startswith(u'Функциональная диаг') and referral_name in fvdp}
        {: comment = """С собой необходимо иметь:<br/>
        - амбулаторную карту<br/>
        - ФЛГ<br/>
        - ингалятор ____________</FONT><FONT SIZE=-1>(название)"""}
    {elif: act_group_name.startswith(u'Функциональная диаг') and referral_name in ekg}
        {: comment = "С собой необходимо иметь амбулаторную карту, предыдущие ленты ЭКГ"}
    {elif: act_group_name.startswith(u'Функциональная диаг') and referral_name in xm}
        {: comment = "С собой необходимо иметь амбулаторную карту, ЭКГ, лейкопластырь шириной 2см."}
        {if: client.sex == u'М'}
            {: comment += "<br/>Просьба сбривать волосы на передней поверхности грудной клетки"}
        {end:}
    {elif: act_group_name.startswith(u'Функциональная диаг') and referral_name in xmad}
        {: comment = "С собой необходимо иметь амбулаторную карту, ЭКГ, лейкопластырь шириной 2см."}
        {if: client.sex == u'М'}
            {: comment += "<br/>Просьба сбривать волосы на передней поверхности грудной клетки"}
        {end:}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzib}
        {: comment = "Взять с собой пеленку"}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzia}
        {: comment = "Взять с собой пеленку"}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzigen}
        {: comment = "Взять с собой пеленку"}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzibrem}
        {: comment = "Взять с собой пеленку; исследование проводится при пустом мочевом пузыре; в случае опоздания может быть отказано в исследовании."}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzi}
        {: comment = "Взять с собой пеленку, голод за 8 ч, исключить мучное, молоко, виноград, бобовые, сыр, фрукты, овощи, за час до исследования выпить 1л воды без газа"}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzimg}
        {: comment = "Взять с собой пеленку"}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzdg}
        {: comment = "Взять с собой пеленку"}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzp}
        {: comment = "Взять с собой пеленку"}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in yzdva}
        {: comment = "Взять с собой пеленку; исследование проводится при пустом мочевом пузыре; в случае опоздания может быть отказано в исследовании."}
    {elif: act_group_name.startswith(u'Ультразвуковая диаг') and referral_name in exo}
        {: comment = """При себе иметь:<br/>
        -ЭКГ лента (годность не более 1 месяца)<br/>
        -амбулаторная карта<br/>
        -полотенце<br/>
        -простынь<br/>
        -предыдущие ЭХО КГ"""}
    {end:}
    <table BORDER=1 WIDTH="100%" cellpadding="0" cellspacing="0" STYLE="font-size: 7pt; color: black">
        <tr>
            <td align="center" COLSPAN=2><b>{currentOrganisation.fullName}</b></td>
        </tr>
        <tr>
            <td align="center" COLSPAN=2><b>Направление на лабораторные исследования (<font size=+1>{referral_name}</font>)</b></td>
        </tr>
        <tr>
{: documentRef = db.getRecordEx(stmt="""
select Client.SNILS as SNILS,
       ClientDocument.serial as document_serial,
       ClientDocument.number as document_number
from Client
left join ClientPolicy on Client.id = ClientPolicy.client_id
left join ClientDocument on Client.id = ClientDocument.client_id
where Client.id = {}
""".format(client.id))}
{: client_SNILS = forceString(documentRef.value('SNILS'))}
            <td align="left" width="25%" {if: comment}rowspan="2"{end:}>
                ФИО: <font SIZE=+2>{client.fullName}</font><br>
                Дата рожд. {client.birthDate} ({client.age} лет),&nbsp;Амб. карта <b>{client.id}</b><br>
                Документ: <b>{forceString(documentRef.value('document_serial'))} {forceString(documentRef.value('document_number'))}</b><br>
                Полис: <b>{client.policy}</b><br>
                Регистрация: <b>{client.regAddress}</b><br>
                Проживание: <b>{client.locAddress}</b><br>
                Снилс: <b>{' '.join(client_SNILS[startIdx:startIdx + 3] for startIdx in range(0, len(client_SNILS), 3))}</b>
            </td>
            <td align="center" width="75%">
                <table width="100%" cellpadding="2">
                    <tr>
                        <td width="15%">Дата: <font size=+1><b>{referral.split(',')[1].split()[0]}</b></font></td>
                        <td width="10%">Номер: <font size=+1><b>{referral_idx}</b></font></td>
                        <td width="10%">Время: <font size=+1><b></b>{referral.split(',')[1].split()[1]}</font></td>
                        <td width="45%">Место: <font size=+1><b>{referral.split(',')[2]}</b></font></td>
                    </tr>
                </table>
            </td>
        </tr>

        {if: comment}
            <tr>
              <td align="center">
                <b><FONT SIZE=+1>
                    {write(comment)}
                </FONT></b>
              </td>
            </tr>
        {end:}
        <tr>
            <td colspan="2">
                <table width="100%">
                    <tr>
                        <td width="20%" align="center">
                            <div><font size=+4 FACE="Code 3 de 9">*{tissue_code}*</font></div>
                            <div>{tissue_code}</div>
                        </td>
                        <td width="80%">
                            <div align="center">
                                {for: analysis in analysis_list}
                                    {analysis[2]}<br>
                                {end:}
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <br>
{end:}
</body>
</html>

