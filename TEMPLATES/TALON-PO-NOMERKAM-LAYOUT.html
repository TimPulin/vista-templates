<!-- изменил Пулин дата 16.06.2025 задача DEV_TEMP-5493 Внести изменения в шаблонах печати направлений на исследования -->
<!-- изменил Волков А.А. дата 22.05.2025 задача DEV_TEMP-5438 Во всех направлениях на анализы снизу или сбоку штрихкода исследования вставить его числовой код -->
<!-- изменил Пулин дата 11.03.2025 задача SUP-50368 При создании направлений на анализы печатается одним направлением, должно двумя -->
<!-- изменил Пулин дата 27.02.2025 задача  -->
<!-- изменил Пулин дата 06.02.2025 задача SUP-49735 Некрректно выходят направления на глюкозу -->
<!-- изменил Каравайчик А.Д. дата 20.01.2024 задача DEV_TEMP-4879 При создании двух направлений на анализ по глюкозе выбираем отдельные номерки на каждый анализ, а на печать все равно выводит оба анализа в одном направлении -->
<!-- изменил Скопцов дата 09.09.2024 задача DEV_TEMP-4370 Шаблон направления на анализы -->
<!-- изменил Пулин дата 27.08.2024 задача DEV_TEMP-4330 При создании направлений на анализы в Кронштадт(рис.1) и Николаевскую - они печатаются вместе. Должны на отдельных листах -->
<!-- правки от 23.07.2024 добавил условие на отрисовку качественное определение -->
<!-- правки от 09.07.2024-->
<!-- правки от 27.06.2024-->
<!-- изменил Пулин дата 26.06.2024 задача DEV_TEMP-4106 Исправить шаблон печати -->
<!-- изменил Пулин дата 21.06.2024 задача DEV_TEMP-4043 Необходимо чтобы  печаталось на одном листе -->
<!-- изменил Елена Агафонова дата 28.05.2024 задача SUP-44731 При распечатки, запись дублируется -->
<!-- изменил Пулин дата 26.04.2024 задача DEV_TEMP-3903 Все анализы распечатываются на одном листе -->
<!-- изменил Пулин дата 19.04.2024 задача DEV_TEMP-3873 Исправить название организации -->
<!-- изменил Пулин дата 13.03.2024 задача DEV_TEMP-3690 ГП122 Внесение изменения в направление v.1 -->
<!--
NOTE
Для контекстов: 'nomerok', 'f025', 'f030', 'token', 'f026', '', 'kon_dn3', 'kon_dn2', 'f025_1'
-->
<!--
NOTE
Для тестирования создал отдельный шаблон select * from rbPrintTemplate where id = 6666762;
чтобы не смущать врачей - после окончания работы ставь delete = 1
-->
<!--
NOTE   ЕСЛИ МЕНЯЕШЬ ОДИН ШАБЛОН - КОПИРУЙ ВО ВСЕ КОНТЕКСТЫ!!!
вот тебе запрос: select * from rbPrintTemplate where id in (6201274, 6201322, 703, 705, 704, 6666697, 6666698, 6666733, 532);
-->
<!DOCTYPE HTML>
<html lang="ru">
<head>
<title>Направление</title>
{:setPageSize('A4')}
{:setOrientation('P')}
{:setTopMargin(5) }
{:setBottomMargin(5) }
{:setRightMargin(5) }
{:setLeftMargin(20)}

{: from PyQt4 import QtGui }
{: from library.Utils import forceString }
{: db = QtGui.qApp.db }

<!--  NOTE утилиты -->
{:
def show(text):
  write("""
    <div> {text}</div>
  """.format(text=text))
}

<!--  NOTE END утилиты -->


<!--  NOTE стили-->
{:
write('''
<style>
  .flex-between {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .font-max {
    font-size: 48px;
  }
  .font-norm {
    font-size: 12pt;
  }
  .font-small {
    font-size: 9pt;
  }
  .barcode--custom {
    font-family: 'Code 3 de 9';
    font-size: 48px;
  }
  .ref-details {
    margin: auto;
    font-size: 16px;
    font-weight: 900;
  }
  .section-solid {
    page-break-inside: avoid;
    margin-bottom: 10px;
  }
  .speed-body td {
    text-align: center;
  }
  .ref-bottom {
    margin: 5px 0 10px;
    font-size: 8pt;
  }
  .square {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 1px solid black;
  }
</style>
''')}
<!--  NOTE END стили-->


<!-- NOTE Отрисовка шапки номера-->
{:
def renderHeader(client, currentOrganisation, Act, Ticket_date, Ticket_time, Ticket_place):
  write("""
    <div class="section-solid">
      <table BORDER=1 WIDTH="100%" cellpadding="3" cellspacing="0" class="font-small">
        <tr>
          <td align="left" COLSPAN=4 style="padding-top: 10px; padding-bottom: 10px">
            <div class="flex-between">
              <span class="barcode--custom">*{client.id}*</span>
              <span class="font-max">{client.id}</span>
            </div>
          </td>
        </tr>
        <tr>
          <td align="center" COLSPAN=4>{currentOrganisation.shortName}</td>
        </tr>
        <tr>
          <td align="center" COLSPAN=4><b>Направление на лабораторные исследования (Работа: {Act})</b></td>
        </tr>
        <tr>
          <td COLSPAN=3 width=70%>
            <div>ФИО: {client.fullName}</div>
            <div>Дата рожд. {client.birthDate} ({client.age}),&nbsp;Амб. карта {client.id}</div>
            <div>Документ:{client.document.serial} {client.document.number}</div>
            <div>Полис: {client.policy}</div>
            <div>Регистрация: {client.regAddress}</div>
            <div>Проживание:{client.locAddress}</div>
            <div>Снилс: {client.SNILS}</div>
          </td>
          <td width="30%">
            <div class="ref-details">
              <div>Дата: {Ticket_date}</div>
              <div>Время: {Ticket_time}</div>
              <div>Место: {Ticket_place}</div>
            </div>
          </td>
        </tr>
      </table>""".format(client=client, currentOrganisation=currentOrganisation, Act=Act, Ticket_date=Ticket_date, Ticket_time=Ticket_time, Ticket_place=Ticket_place))
}
<!-- NOTE END Отрисовка шапки номера-->


<!-- NOTE Отрисовка футера-->
{:
def renderFooter(localAct, orgName, orgCode):
  write("""
    <div  class="ref-bottom">
      <div>
        Направил: <b>{localAct.setPerson}</b> __________________
        Дата направления: <b>{begDate}</b>
      </div>
      <div>
        Наименование и код принимающей организации:
        <b>{orgName}</b>
        <b>{orgCode}</b>
      </div>
    </div>
  """.format(localAct=localAct, orgName=orgName, orgCode=orgCode, begDate=event.setDate.date.toString('dd.MM.yyyy')))
}
<!-- NOTE END Отрисовка футера-->

{:
def getOrgInfo(currentAct):
  organisationRef = db.getRecordEx(stmt=u"""
    select o.shortName as name, o.miacCode as code
    from Action a
        join Organisation o on a.org_id = o.id
    where a.id = {actionId};
  """.format(actionId=currentAct.id))

  if organisationRef:
    orgName = forceString(organisationRef.value('name'))
    orgCode = forceString(organisationRef.value('code'))
  else:
    if currentAct.group.group.id == 44113:
      orgName = 'СПб ГБУЗ "Городская поликлиника №122"'
      orgCode = 23318
    else:
      orgName = 'ГУЗ "Николаевская больница"'
      orgCode = 250
  return [orgName, orgCode]
}

{:
def createIdForGrouping(refInfo, postfix):
  return forceString(refInfo.id) + postfix
}

<!-- NOTE новая логика поиска номерков-->
{:
class ReferralAnal:
  def __init__(self, act, refInfo, postfix):
    self.Ticket_datetime = refInfo.datetime.toString(u"dd.MM.yyyy, hh:mm")
    self.Ticket_date = refInfo.datetime.toString(u"dd.MM.yyyy")
    self.Ticket_time = refInfo.datetime.toString(u"hh:mm")
    self.Ticket_number = refInfo.idx+1
    self.Ticket_id = refInfo.id
    self.Ticket_place_full = refInfo.orgStructure
    self.Ticket_place =  refInfo.orgStructure.code
    self.Job_type = refInfo.jobType

    self.orgName = ''
    self.orgCode = ''

    self.actList = []
    self.refInfo = refInfo

    self.idForGrouping = createIdForGrouping(self.refInfo, postfix)

    self.addAct(act)
    self.getOrgInfo(act)


  def getOrgInfo(self, act):
    orgName, orgCode = getOrgInfo(act)
    self.orgName = orgName
    self.orgCode = orgCode

  def addAct(self, act):
    self.actList.append(act)


def createNewReferralAnal(refList, act, prop, postfix):
  newInstance = ReferralAnal(act, prop.value, postfix)
  refList.append(newInstance)
}

{:
def makePostfix(act, prefix):
  postfix = u''
  if act.name == u'Глюкоза плазмы натощак':
    postfix = u'glukoze_plazma_divided'
  elif act.name == u'Глюкоза через 60 мин после нагрузки глюкозой':
    postfix = u'glukoze_after_hour_divide'
  elif act.name == u'Глюкоза через 120 мин после нагрузки глюкозой':
    postfix = forceString(act.id)
  elif act.group.id == 44202:
    postfix = u'izoserologia'
  elif currentJobType == '04':
    postfix = u'bruh'
  elif (currentJobType == '6' or currentJobType =='bhiv') and u'вич' in act.name.lower():
    postfix = u'aid'
  elif currentJobType == '6' and u'боррел' in act.name.lower():
    postfix = u'borrelioz'
  elif currentJobType == '6' and u'энцефал' in act.name.lower():
    postfix = u'encefalit'
  elif currentJobType == '6' and u'hepatitis' in act.name.lower():
    postfix = u'hepatitis'
  elif currentJobType == '17161' and u'цитолог' in act.name.lower():
    postfix = u'citologia'

  elif u'роскопическое исследование отделяемого из левого уха' in act.name.lower():
      postfix = u'micr_right_ear'
  elif u'роскопическое исследование отделяемого из правого уха' in act.name.lower():
      postfix = u'micr_left_ear'
  elif u'исследование отделяемого из правого уха' in act.name.lower():
      postfix = u'right_ear'
  elif u'исследование отделяемого из левого уха' in act.name.lower():
      postfix = u'left_ear'
  elif u'отделяемого из левого глаза' in act.name.lower():
      postfix = 'left_eye'
  elif u'отделяемого из правого глаза' in act.name.lower():
      postfix = 'right_eye'
  elif u'молока из левой груди на золотистый стафилококк' in act.name.lower():
      postfix = 'left_breast'
  elif u'молока из правой груди на золотистый стафилококк' in act.name.lower():
      postfix = 'right_breast'

  elif currentJobType == '6-1':
    postfix = u'aidFirst'
  elif currentJobType == '7':
    postfix = 'kal'
  elif currentJobType == '8':
    postfix = 'mocha'
  elif act.code == u'A26.20.008.993':
    postfix = u'Human_papilloma_virus_all'
  elif act.code == u'A08.20.017':
    postfix = u'morf_research_vulva'
  elif u'качественное определение' in act.name:
    postfix = u'best_anal_definition'
  elif u'качественное определение' in act.name:
    postfix = u'best_anal_definition'
  else:
    postfix = u''

  postfix = prefix + u'_' + postfix
  return postfix
}

{:
MAIN_REF_LIST = []

for act in event.actions:
  if act.class_ == 1:
    for prop in act:
      if prop.typeName == u'JobTicket' and prop.value:
        currentJobType = prop.value.jobType.code
        if u'кронштадт' in act.name.lower():
          postfix = makePostfix(act, u'kron_city')
        else:
          postfix = makePostfix(act, u'')

        idForGrouping = createIdForGrouping(prop.value, postfix)

        filteredRefList = filter(lambda x: x.idForGrouping == idForGrouping, MAIN_REF_LIST)
        filteredRef = filteredRefList[0] if len(filteredRefList) > 0 else None
        if filteredRef:
          filteredRefList[0].addAct(act)
        else:
          createNewReferralAnal(MAIN_REF_LIST, act, prop, postfix)

}
<!-- NOTE END новая логика поиска номерков-->

</head>
<body>

{for: ref in MAIN_REF_LIST}
    {if: ref.Job_type == '04'}
      <div class="section-solid">
        <div style="font-size: 9pt;">
          <table width="100%">
              <tr>
                  <td valign="middle" width="50%">Направление № {ref.Ticket_number}</td>
                  <td align="right" width="50%"><font style="font-size: 7pt">{currentOrganisation.shortName}</font></td>
              </tr>
          </table>
          <table border="1" cellpadding="3" cellspacing="0" width="100%">
              <tr>
                  <td width="15%"></td>
                  <td width="60%">
                    <div class="flex-between">
                      <span class="font-max">Дата: {ref.Ticket_datetime} Номер стекла:</span>
                      <span class="barcode--custom">*{client.id}*</span>
                    </div>
                  </td>
              </tr>
              <tr>
                  <td colspan="2">
                    <div>ФИО: {client.fullName}</div>
                    <div>Дата рожд. {client.birthDate} ({client.age}),&nbsp;Амб. карта {client.id}</div>
                    <div>
                      Документ:{client.document.serial} {client.document.number} СНИЛС: {client.SNILS}
                      Пол {if: client.sex == u'М'}мужской{end:}{if: client.sex == u'Ж'}женский{end:}
                    </div>
                    <div>Полис: {client.policy}</div>
                    <div>Регистрация: {client.regAddress}</div>
                    <div>Проживание:{client.locAddress}</div>
                    <div>Снилс: {client.SNILS}</div>
                  </td>
                  <td></td>
              </tr>
          </table>
          <br>
          <br>
          <div class="font-norm">
            Дата П.М.:{'_' * 20}
            Диагноз:
            {for: diag in event.diagnosises}
                {if: diag.type.name == u"Основной"}
                    {diag.MKB} - {diag.MKB.descr}
                {elif: diag.type.name == u"Заключительный"}
                    {diag.MKB} - {diag.MKB.descr}
                {end:}
            {end:}
            <br>
            Согласие на обработку персональных данных и забор жидкостной цитологии<br>
            ____________________________/
          </div>
          {for: act in ref.actList}
            <div>{act.code} - {act.name}</div>
          {end:}
    {elif: ref.Job_type == '6-1'}
      <div class="section-solid">
        <div align="right" class="font-small">Приложение<br>к приказу Министерства здравоохранения СССР<br>от 05.09.1988</div>
        <table width="100%" cellpadding="3" cellspacing="0" border="1">
          <tr>
            <td valign="middle">Код формы по ОКУД</td>
            <td>
              {for: i in range(10)}
                <div class="square"></div>
              {end:}
            </td>
            <td></td>
          </tr>
        </table>
        <table class="font-small">
          <tr>
            <td align="center" width="20%">Минздрав РФ<hr>{currentOrganisation.shortName}</td>
            <td width="50%"></td>
            <td width="30%" align="right">Медицинская документация<br><b>Форма № 264/у-88</b><br>Утверждена Минздравом СССР<br>05.09.1988 г. № 590</td>
          </tr>
        </table>
        <div align="center">
          <b>НАПРАВЛЕНИЕ № {ref.Ticket_number} <br>
          на исследование образцов крови в ИФА на СПИД<br>
          в</b>
        </div>
        <table border="1" cellpadding="3" cellspacing="0" style="width:100.0%;" width="100%">
          <tbody class="speed-body">
            <tr>
              <td style="width:5.72%;height:16px;">
                N<br> п/п
              </td>
              <td style="width:8.62%;height:16px;">
                Регистра-<br> ционный<br> номер
              </td>
              <td style="width:24.92%;height:16px;">
                Фамилия, имя,<br> отчество<br> (полностью)
              </td>
              <td style="width:4.2%;height:16px;">
                пол
              </td>
              <td style="width:8.2%;height:16px;">
                Год<br> рожд.
              </td>
              <td style="width:26.72%;height:16px;">
                Домашний<br> адрес
              </td>
              <td style="width:7.2%;height:16px;">
                Код<br> контин-<br> гента
              </td>
              <td style="width:5.54%;height:16px;">
                Дата<br> забора<br> крови
              </td>
              <td style="width:8.86%;height:16px;">
                исследо-<br> вания
              </td>
            </tr>
            <tr>
              <td style="width:5.72%;">01</td>
              <td style="width:8.62%;">02</td>
              <td style="width:24.92%;">03</td>
              <td style="width:4.2%;">04</td>
              <td style="width:8.2%;">05</td>
              <td style="width:26.72%;">06</td>
              <td style="width:7.2%;">07</td>
              <td style="width:5.54%;">08</td>
              <td style="width:8.86%;">09</td>
            </tr>
            <tr>
              <td style="width:5.72%;">1</td>
              <td style="width:8.62%;">&nbsp;</td>
              <td style="width:24.92%;">{client.fullName}</td>
              <td style="width:4.2%;">{client.sex}</td>
              <td style="width:8.2%;">{client.birthDate}</td>
              <td style="width:26.72%;">
                  {client.locAddress.street}&nbsp; дом &nbsp;{client.locAddress.number} &nbsp; кор. &nbsp; {client.locAddress.corpus} &nbsp; кв. &nbsp; {client.locAddress.flat}
              </td>
              <td style="width:7.2%;">&nbsp;</td>
              <td style="width:5.54%;">{ref.Ticket_datetime}</td>
              <td style="width:8.86%;">&nbsp;</td>
            </tr>
          </tbody>
        </table>
    {else:}
      {:renderHeader(client, currentOrganisation, ref.Job_type, ref.Ticket_date, ref.Ticket_time, ref.Ticket_place)}
      {for: act in ref.actList}
        <div>{act.name}</div>
      {end:}
    {end:}

    <div class="barcode--custom">*{ref.Ticket_id}*</div>
    <div style="letter-spacing: 20px;font-size:8pt">{ref.Ticket_id}</div>
    {:renderFooter(ref.actList[0], ref.orgName, ref.orgCode)}
    </div> <!--END section-solid-->
    <div style="page-break-after: always"></div>
{end:}

</body>
</html>

