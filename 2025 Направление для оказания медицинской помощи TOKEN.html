<!--Начальная дата разработки 20.10.2025 г.-->
<!--Разработка: Пулин -->
<!--Контекст печати:  -->
<!--Задача:  -->

<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Направление для оказания медицинской помощи</title>
<!-- @formatter:off -->
{: setPageSize('A4')}
{: setOrientation('P')}
{: setTopMargin(5)}
{: setBottomMargin(5)}
{: setRightMargin(17)}
{: setLeftMargin(17)}

{: from library.Utils import smartDict }
{: from library.Utils import forceString }
{: from library.Utils import forceInt }
{: from PyQt4 import QtGui }
{: db = QtGui.qApp.db }

{: month = [u'a', u'января', u'февраля', u'марта', u'апрель', u'мая', u'июня', u'июля', u'августа', u'сентября', u'октября', u'ноября', u'декабря']}

{:
write('''
<style>
.h1 {
    text-align: center;
    margin-bottom: 20px;
    font-size: 14pt;
    font-weight: 900;
}
.main {
    font-family: 'Times New Roman';
    font-size: 12pt;
}
.small {
  font-size: 8pt;
}

.xs {
  font-size: 8pt;
}

.bold {
  font-weight: 900;
}
.red-line {
  text-indent: 10px;
}
.white-wrap {
  white-space: nowrap;
}
</style>
''')}


{:
def render_line(str, base_length = 80):
  return u'_' * (base_length - len(str))
}
<!-- @formatter:on -->
</head>
<body>

<div class="main">

  <header class="header">
    <table width="100%" cellpadding="0" cellspacing="0">
      <tr>
        <td width="1%" valign="top">
          <div class="white-wrap xs">
            Наименование и адрес медицинской организации <br>
            (фамилия, имя, отчество (при наличии) <br> индивидуального предпринимателя и адрес <br> осуществления медицинской деятельности)
          </div>
          <div>
            <b>{currentOrganisation.title}</b>
          </div>
          <div>
            <b>{currentOrganisation.address}</b>
          </div>
          <div class="white-wrap xs">
            Основной государственный регистрационный номер <br> (Основной государственный регистрационный <br>
            номер индивидуального предпринимателя)
          </div>
          <div>
            <b>{currentOrganisation.OGRN}</b>
          </div>
        </td>
        <td></td>
        <td width="1%" valign="top" class="small">
          <div class="white-wrap">Медицинская документация</div>
          <div class="white-wrap">Учетная форма № 057/у</div>
          <div class="white-wrap">Утверждена приказом Министерства <br> здравоохранения Российской Федерации</div>
          <div class="white-wrap">от 13 мая 2025 г. № 274н</div>
        </td>
      </tr>
    </table>
  </header>

  <br>

  <div align="center" class="h1">Направление для оказания медицинской помощи №______</div>

  <br>

  <div>
    Дата заполнения направления:
    {if: event}
      «{event.setDate.toString('dd')}» {forceString(month[event.setDate.month])} {forceString(event.setDate.year)} г.
    {else:}
      «____» ______ 20____г.
    {end:}

  </div>

    <div>
      Полис обязательного медицинского страхования
      серия <b>{client.policy.serial}</b>
      № <b>{client.policy.number}</b>
    </div>

    <div>
      дата выдачи полиса обязательного медицинского страхования:
      {if: client.policy.begDate}
          <b>«{forceString(client.policy.begDate.toString('dd'))}» {forceString(month[client.policy.begDate.date.month()])} {forceString(client.policy.begDate.date.year())} г.</b>
      {else:}
        «____» ______ 20____г.
      {end:}
    </div>

    <div>
      данные о страховой медицинской организации, выбранной застрахованным лицом или определенной застрахованному лицу:
      <b>{client.compulsoryPolicy.insurer}</b>
    </div>

    <div>
      Фамилия, имя, отчество (при наличии) пациента <b>{client.fullName}</b>
    </div>

    <div>
      Дата рождения:
      <b>«{forceString(client.birthDate.toString('dd'))}» {forceString(month[client.birthDate.date.month()])} {forceString(client.birthDate.date.year())} г.</b>
      Пол: <span class="xs">муж. – 1, жен. – 2</span>  <b>{1 if client.sex == u'М' else 2}</b>
    </div>



<!-- note Регистрация по месту -->
<section>
{:
def check_city(city):
  return (city and city.socr and (city.socr.strip() == "г." or city.socr.strip() == "г"))
}

{:
def get_district(district):
  if district:
    dst = district.strip()
    if dst.endswith('р-н'):
      return dst[:-3]
    elif dst.endswith('р-н.'):
      return dst[:-4]
  return None
}

{:
def get_region(region):
  prefix = u''
  postfix = u''
  if u'г' in region.socr:
    prefix = region.socr

  if u'кра' in region.socr:
    postfix = region.socr

  return postfix + region.name + postfix
}

  <div>
    Регистрация по месту жительства:
    {if: client.regAddress.region}
        субъект Российской Федерации
        <b>{get_region(client.regAddress.region)}</b>
    {end:}
  </div>
  <div>
    {: isToRenderAddrString = True}
    <div>
      {: dst = get_district(client.regAddress.district)}
      {if: dst} район <b>{dst}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {: isToRenderAddrString = False} {end:}
      {if: check_city(client.regAddress.parentCity)} город <b>{client.regAddress.parentCity.name}</b> {: isToRenderAddrString = False}{end:}
      {if: client.regAddress.city}населенный пункт <b>{client.regAddress.city.name}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
    </div>

    <div>
      {if: client.regAddress.street} {client.regAddress.street.socr} <b>{client.regAddress.street.name}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
      {if: client.regAddress.number} дом <b>{client.regAddress.number}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
      {if: client.regAddress.corpus} корпус <b>{client.regAddress.corpus}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
      {if: client.regAddress.flat} квартира <b>{client.regAddress.flat}</b> {: isToRenderAddrString = False}{end:}
    </div>

    <!-- note на случай, если адрес введен в виде строки, а не с использованием КЛАДР -->
    {if: isToRenderAddrString}
        <b>{client.regAddress}</b>
    {end:}
  </div>

  <div>
    Регистрация по месту пребывания:
    {if: client.locAddress.region}
        субъект Российской Федерации
        <b>{get_region(client.locAddress.region)}</b>
    {end:}
  </div>
  <div>
    {: isToRenderAddrString = True}
    <div>
      {: dst = get_district(client.locAddress.district)}
      {if: dst} район <b>{dst}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {: isToRenderAddrString = False} {end:}
      {if: check_city(client.locAddress.parentCity)} город <b>{client.locAddress.parentCity.name}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {: isToRenderAddrString = False}{end:}
      {if: client.locAddress.corpus} корпус <b>{client.locAddress.corpus}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
      {if: client.locAddress.city}населенный пункт <b>{client.locAddress.city.name}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
    </div>

    <div>
      {if: client.locAddress.street} {client.locAddress.street.socr} <b>{client.locAddress.street.name}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
      {if: client.locAddress.number} дом <b>{client.locAddress.number}</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {: isToRenderAddrString = False}{end:}
      {if: client.locAddress.flat} квартира <b>{client.locAddress.flat}</b> {: isToRenderAddrString = False}{end:}
    </div>
    {if: isToRenderAddrString}
        <b>{client.locAddress}</b>
    {end:}
  </div>
</section>
<!-- note END Регистрация по месту -->

<div>
  Местность
  {:incity = (str(client.regAddress.KLADRCode)[8:11] == '000')}
  {if: incity} <b>городская</b> {else:} <b>сельская</b> {end:}
</div>


{:
workStatus = 'прочие'
workStatusCodeList = [u'1', u'2', u'с05', u'5', u'6', u'7']

workStatusDic = smartDict()
workStatusDic[u'1'] = u'прочие'
workStatusDic[u'6'] = u'пенсионер(ка)'
workStatusDic[u'5'] = u'не работает'
workStatusDic[u'2'] = u'студент(ка)'
workStatusDic[u'с05'] = u'работает'
workStatusDic[u'7'] = u'проходит военную службу или приравненную к ней службу'

for stat in client.socStatuses:
    if stat.code in workStatusCodeList:
      if stat.code == u'2':
        age = forceInt(forceString(client.age).split(' ', 1)[0])
        if age > 17:
          workStatus = workStatusDic[stat.code]
        else:
          workStatus = workStatusDic[u'1']
      else:
        workStatus = workStatusDic[stat.code]
}


<div>
  <!-- todo -->
  Занятость: <span class="xs">работает – 1, проходит военную и приравненную к ней службу – 2; пенсионер – 3, обучающийся – 4, не работает – 5, прочее – 6</span>
</div>


{:
DiagID = u''
DiagName = u''
if event:
  main_diag_ref = db.getRecordEx(stmt=u"""
    select mkb.DiagID, mkb.DiagName
    from Diagnosis ds
             join MKB mkb on ds.MKB = mkb.DiagID
    where ds.id = getEventDiagnosis({event_id})
  """.format(event_id=event.id))
  if main_diag_ref:
    DiagID = forceString(main_diag_ref.value(u'DiagID'))
    DiagName = forceString(main_diag_ref.value(u'DiagName'))
}

<div>
  Код по Международной статистической классификации болезней и проблем, связанных со здоровьем:
  <b>{DiagID}</b>
</div>

<div>
  Направляется для оказания медицинской помощи:
  {render_line(u'Направляется для оказания медицинской помощи:')}
</div>

<div>
  форма: <span class="xs">экстренная — 1, неотложная — 2, плановая — 3;</span>
</div>


<div>
  вид:
  <span class="xs">
    первичная медико-санитарная помощь, в том числе специализированная — 1, специализированная, в том числе высокотехнологичная медицинская помощь — 2, паллиативная медицинская помощь — 3; скорая специализированная медицинская помощь - 4;
  </span>
</div>

<div>
  условия:
  <span class="xs">амбулаторно — 1; в дневном стационаре — 2; стационарно — 3.</span>
</div>


<div>
  Обоснование (показания) направления с указанием числа назначаемых курсов (циклов) лечения
  {render_line(u'Обоснование (показания) направления с указанием числа назначаемых курсов (циклов) лечения')}

  <div>{render_line(u'')}</div>
  <div>{render_line(u'')}</div>
</div>

<div>
  Должность, специальность медицинского работника, направившего пациента
  {render_line(u'Должность, специальность медицинского работника, направившего пациента')}
  <div>{render_line(u'')}</div>
</div>

<table width="100%" cellpadding="0" cellspacing="0">
  <tr>
    <td width="98%"></td>
    <td align="center" width="1%">
      <div class="white-wrap">{'_' * 20}&nbsp;</div>
      <div class="white-wrap"><sup>(подпись)</sup>&nbsp;</div>
    </td>
    <td align="center" width="1%">
      <div class="white-wrap">{'_' * 40}&nbsp;</div>
      <div class="white-wrap"><sup>Фамилия, имя, отчество (при наличии)</sup>&nbsp;</div>
    </td>
  </tr>
</table>

  <br>

  <div>	М.П. (при наличии)</div>

</div>
</body>
</html>